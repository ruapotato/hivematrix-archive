<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive - Historical Billing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; color: #333; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 5px; font-weight: 500; }
        .stat-card .value { font-size: 32px; color: #333; font-weight: 600; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { font-size: 18px; color: #333; margin-bottom: 15px; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .search-bar input { flex: 1; min-width: 200px; }
        .search-bar button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .search-bar button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 13px; text-transform: uppercase; }
        table tr:hover { background: #f8f9fa; }
        .btn { display: inline-block; padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .actions { display: flex; gap: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¦ Archive - Historical Billing</h1>
            <p style="color: #666; margin-top: 5px;">Immutable billing snapshots for historical record-keeping</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Snapshots</h3>
                <div class="value">{{ total_snapshots }}</div>
            </div>
            <div class="stat-card">
                <h3>Companies Archived</h3>
                <div class="value">{{ total_companies }}</div>
            </div>
            <div class="stat-card">
                <h3>Archive Status</h3>
                <div class="value" style="font-size: 20px;">âœ“ Active</div>
            </div>
        </div>

        <div class="card">
            <h2>Search Historical Bills</h2>
            <div class="search-bar">
                <input type="text" id="searchAccount" placeholder="Account Number">
                <input type="text" id="searchCompany" placeholder="Company Name">
                <select id="searchYear">
                    <option value="">All Years</option>
                    {% for year in range(2020, 2030) %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
                <select id="searchMonth">
                    <option value="">All Months</option>
                    {% for month in range(1, 13) %}
                    <option value="{{ month }}">{{ "%02d"|format(month) }} - {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month-1] }}</option>
                    {% endfor %}
                </select>
                <button onclick="searchSnapshots()">Search</button>
                <button onclick="clearSearch()" style="background: #6c757d;">Clear</button>
            </div>
            <div id="searchResults"></div>
        </div>

        <div class="card">
            <h2>Recent Snapshots</h2>
            {% if recent_snapshots %}
            <table>
                <thead>
                    <tr>
                        <th>Invoice Number</th>
                        <th>Company</th>
                        <th>Period</th>
                        <th>Archived</th>
                        <th>Total Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for snapshot in recent_snapshots %}
                    <tr>
                        <td><strong>{{ snapshot.invoice_number }}</strong></td>
                        <td>{{ snapshot.company_name }}</td>
                        <td>{{ snapshot.billing_year }}-{{ "%02d"|format(snapshot.billing_month) }}</td>
                        <td>{{ snapshot.archived_at[:10] }}</td>
                        <td>${{ "%.2f"|format(snapshot.total_amount) }}</td>
                        <td class="actions">
                            <a href="api/snapshot/{{ snapshot.invoice_number }}" class="btn btn-secondary" target="_blank">View JSON</a>
                            <a href="api/snapshot/{{ snapshot.invoice_number }}/csv" class="btn">Download CSV</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty">No snapshots archived yet. Bills will appear here once accepted in Ledger.</div>
            {% endif %}
        </div>

        <div class="card">
            <h2>Scheduled Snapshots</h2>
            <p style="color: #666; margin-bottom: 15px;">Automated snapshot creation is configured to run on a schedule.</p>
            <div id="schedulerInfo">Loading...</div>
        </div>
    </div>

    <script>
        // Load scheduler configuration
        fetch('api/scheduler/config', {
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                const config = data.config;
                const infoDiv = document.getElementById('schedulerInfo');

                if (!config) {
                    infoDiv.innerHTML = '<p style="color: #999;">No scheduler configuration found.</p>';
                    return;
                }

                const statusBadge = config.enabled
                    ? '<span class="badge badge-success">Enabled</span>'
                    : '<span class="badge badge-warning">Disabled</span>';

                const lastRun = config.last_run_at
                    ? new Date(config.last_run_at).toLocaleString()
                    : 'Never';

                infoDiv.innerHTML = `
                    <p><strong>Status:</strong> ${statusBadge}</p>
                    <p><strong>Schedule:</strong> Day ${config.day_of_month} of each month at ${config.hour}:00</p>
                    <p><strong>Target:</strong> ${config.snapshot_previous_month ? 'Previous month' : 'Current month'} billing</p>
                    <p><strong>Companies:</strong> ${config.snapshot_all_companies ? 'All companies' : 'Configured companies'}</p>
                    <p><strong>Last Run:</strong> ${lastRun}</p>
                    ${config.last_run_status ? `<p><strong>Last Status:</strong> ${config.last_run_status} (${config.last_run_count || 0} snapshots)</p>` : ''}
                `;
            })
            .catch(err => {
                document.getElementById('schedulerInfo').innerHTML = '<p style="color: #dc3545;">Error loading scheduler info.</p>';
            });

        // Search functionality
        function searchSnapshots() {
            const account = document.getElementById('searchAccount').value;
            const company = document.getElementById('searchCompany').value;
            const year = document.getElementById('searchYear').value;
            const month = document.getElementById('searchMonth').value;

            const params = new URLSearchParams();
            if (account) params.append('account_number', account);
            if (year) params.append('year', year);
            if (month) params.append('month', month);

            fetch('api/snapshots/search?' + params.toString(), {
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById('searchResults');

                    if (data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="empty">No snapshots found matching your criteria.</div>';
                        return;
                    }

                    let html = `<p style="margin-bottom: 10px; color: #666;">Found ${data.total} snapshots</p>`;
                    html += '<table><thead><tr><th>Invoice</th><th>Company</th><th>Period</th><th>Archived</th><th>Total</th><th>Actions</th></tr></thead><tbody>';

                    // Filter by company name if specified
                    let results = data.results;
                    if (company) {
                        results = results.filter(s => s.company_name.toLowerCase().includes(company.toLowerCase()));
                    }

                    results.forEach(s => {
                        html += `
                            <tr>
                                <td><strong>${s.invoice_number}</strong></td>
                                <td>${s.company_name}</td>
                                <td>${s.billing_year}-${s.billing_month.toString().padStart(2, '0')}</td>
                                <td>${s.archived_at.substring(0, 10)}</td>
                                <td>$${s.total_amount.toFixed(2)}</td>
                                <td class="actions">
                                    <a href="api/snapshot/${s.invoice_number}" class="btn btn-secondary" target="_blank">View</a>
                                    <a href="api/snapshot/${s.invoice_number}/csv" class="btn">CSV</a>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    resultsDiv.innerHTML = html;
                })
                .catch(err => {
                    document.getElementById('searchResults').innerHTML = '<div class="empty" style="color: #dc3545;">Error performing search.</div>';
                });
        }

        function clearSearch() {
            document.getElementById('searchAccount').value = '';
            document.getElementById('searchCompany').value = '';
            document.getElementById('searchYear').value = '';
            document.getElementById('searchMonth').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }
    </script>
</body>
</html>
